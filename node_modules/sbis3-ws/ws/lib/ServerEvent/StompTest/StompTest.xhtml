%{INCLUDE "/Tema_Skrepka/Шаблоны/includes/common-doctype.html"}
%{INCLUDE "/Tema_Skrepka/Шаблоны/includes/common-html-definition.html"}
<head>
    %{INCLUDE "/Tema_Skrepka/Шаблоны/includes/common-meta.html"}

    <title>Тестовая страница STOMP</title>

    <script type="text/javascript">
        // new config support
        window.wsConfig = {
            wsRoot: '%{WI.SBIS_ROOT}',
            appRoot: '%{APPLICATION_ROOT}',
            resourceRoot: '%{RESOURCE_ROOT}',
            defaultServiceUrl: '%{SERVICES_PATH}',
            fasttemplate: true,
            userConfigSupport: %{CONFIG.USER_PARAMS},
            globalConfigSupport: %{CONFIG.GLOBAL_PARAMS}
        };
    </script>

    %{INCLUDE "/Tema_Skrepka/Шаблоны/includes/ws.html"}

    <script type="text/javascript">
       var TIME_LIMIT = 15000;
       var _Test = {
          'times': {
             'start': Date.now(),
             'coreReady': 0,
             'busReady': 0,
             'channelReady': 0,
             'msgSent': 0,
             'msgReceived': 0,
             'callDone': 0
          },
          'msgID': Math.random() * 1e6 | 0
       };

       requirejs(["Core/core-init"], function(coreInit){
          coreInit.addCallback(function() {
             _Test.times.coreReady = Date.now();
             requirejs(['Lib/ServerEvent/Bus'], function(ServerEventBus) {
                _Test.times.busReady = Date.now();
                ServerEventBus.serverChannel('system.echo', {exclusive: true})
                   .subscribe('onReady', function onReady() {
                      _Test.times.channelReady = Date.now();
                      onEverythingReady();
                   })
                   .subscribe('onMessage', onMessage);
             });
          });
       });

       function onMessage(event, data) {
          if (typeof data === 'object' && data.id === _Test.msgID) {
             _Test.times.msgReceived = Date.now();
             done();
          }
       }
       function onEverythingReady() {
          _Test.times.msgSent = Date.now();
          var payload = {
             'ts': _Test.times.msgSent,
             'id': _Test.msgID
          };

          requirejs(['WS.Data/Source/SbisService'], function (SbisService) {
             var source = new SbisService({endpoint: 'Test'});
             source.call('PushEcho', {'payload': payload})
                .addCallbacks(
                   function onDone() {
                      _Test.times.callDone = Date.now();
                   },
                   function onError() {
                      _Test.times.callDone = -1;
                   }
                );
          });
          setTimeout(done, TIME_LIMIT);
       }
       function done() {
          if (window.opener && window.opener._Test) {
             window.opener._Test.res = _Test.times;
             window.close();
          }
       }
    </script>
</head>
<body>
</body>
</html>

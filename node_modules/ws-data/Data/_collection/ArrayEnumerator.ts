/// <amd-module name="Data/_collection/ArrayEnumerator" />
/**
 * Энумератор для массива
 * @class WS.Data/Collection/ArrayEnumerator
 * @implements WS.Data/Collection/IEnumerator
 * @mixes WS.Data/Collection/IndexedEnumeratorMixin
 * @public
 * @author Мальцев А.А.
 */

import IEnumerator from './IEnumerator';
import IndexedEnumeratorMixin from './IndexedEnumeratorMixin';
import {mixin, di} from '../util';

export default class ArrayEnumerator<T> extends mixin(
   Object,
   IndexedEnumeratorMixin
) implements IEnumerator<T> /** @lends WS.Data/Collection/ArrayEnumerator.prototype */{
   readonly '[Data/_collection/IEnumerator]': true;

   /**
    * Конструктор
    * @param {Array} items Массив
    */
   constructor(items: Array<T>) {
      super();
      let checkedItems = items;
      if (checkedItems === undefined) {
         checkedItems = [];
      }
      if (!(checkedItems instanceof Array)) {
         throw new Error('Argument items should be an instance of Array');
      }
      this._items = checkedItems;
      IndexedEnumeratorMixin.constructor.call(this);
   }

   // region WS.Data/Collection/IEnumerator

   getCurrent(): any {
      if (this._index < 0) {
         return undefined;
      }
      return this._resolver ? this._resolver(this._index) : this._items[this._index];
   }

   getCurrentIndex(): number {
      return this._index;
   }

   moveNext(): boolean {
      if (1 + this._index >= this._items.length) {
         return false;
      }
      this._index++;

      const current = this.getCurrent();
      if (this._filter && !this._filter(current, this._index)) {
         return this.moveNext();
      }

      return true;
   }

   reset() {
      this._index = -1;
   }

   // endregion WS.Data/Collection/IEnumerator

   // region Public methods

   /**
    * Устанавливает резолвер элементов по позиции
    * @param {function(Number): *} resolver Функция обратного вызова, которая должна по позиции вернуть элемент
    */
   setResolver(resolver: (index: number) => any) {
      this._resolver = resolver;
   }

   /**
    * Устанавливает фильтр элементов
    * @param {function(*): Boolean} filter Функция обратного вызова, которая должна для каждого элемента вернуть
    * признак, проходит ли он фильтр
    */
   setFilter(filter: (item: any, index: any) => boolean) {
      this._filter = filter;
   }

   // endregion Public methods
}

ArrayEnumerator.prototype['[Data/_collection/ArrayEnumerator]'] = true;

/**
 * @property {Array} Массив
 */
ArrayEnumerator.prototype._items = null;

/**
 * @property {Number} Текущий индекс
 */
ArrayEnumerator.prototype._index = -1;

/**
 * @property {function(Number): *} Резолвер элементов
 */
ArrayEnumerator.prototype._resolver = null;

/**
 * @property {function(*): Boolean} Фильтр элементов
 */
ArrayEnumerator.prototype._filter = null;

di.register('Data/collection:ArrayEnumerator', ArrayEnumerator, {instantiate: false});

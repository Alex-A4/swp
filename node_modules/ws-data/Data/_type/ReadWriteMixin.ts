/// <amd-module name="Data/_type/ReadWriteMixin" />
/**
 * Миксин, позволяющий ограничивать запись и чтение.
 * Подмешивается после WS.Data/Entity/ObservableMixin и после WS.Data/Entity/ManyToManyMixin, перекрывая часть их методов
 * @mixin WS.Data/Entity/ReadWriteMixin
 * @public
 * @author Мальцев А.А.
 */

import OptionsMixin from  './OptionsMixin';
import ObservableMixin from  './ObservableMixin';
import ManyToManyMixin from  './ManyToManyMixin';
import {protect} from '../util';

let hasOwnProperty = Object.prototype.hasOwnProperty;

/**
 * Свойство, хранящее признак возможности записи
 */
let $writable = protect('writable');

const ReadWriteMixin = /** @lends WS.Data/Entity/ReadWriteMixin.prototype */{
   '[Data/_type/ReadWriteMixin]': true,

   //region WS.Data/Entity/ReadWriteMixin

   get writable() {
      return this[$writable];
   },

   constructor(options) {
      if (this._options && hasOwnProperty.call(this._options, 'writable')) {
         this[$writable] = this._options.writable;
      }
      if (options && hasOwnProperty.call(options, 'writable')) {
         this[$writable] = options.writable;
      }
      if (this[$writable]) {
         ObservableMixin.apply(this, arguments);
      }
   },

   destroy() {
      if (this[$writable]) {
         ObservableMixin.prototype.destroy.call(this);
         ManyToManyMixin.destroy.call(this);
      }
   },

   //endregion WS.Data/Entity/ReadWriteMixin

   //region WS.Data/Entity/ObservableMixin

   subscribe(event, handler, ctx) {
      if (this[$writable]) {
         return ObservableMixin.prototype.subscribe.call(this, event, handler, ctx);
      }
   },

   unsubscribe(event, handler, ctx) {
      if (this[$writable]) {
         return ObservableMixin.prototype.unsubscribe.call(this, event, handler, ctx);
      }
   },

   _publish() {
      if (this[$writable]) {
         // @ts-ignore
         return ObservableMixin.prototype._publish.apply(this, arguments);
      }
   },

   _notify() {
      if (this[$writable]) {
         // @ts-ignore
         return ObservableMixin.prototype._notify.apply(this, arguments);
      }
   },

   //endregion WS.Data/Entity/ObservableMixin

   //region WS.Data/Entity/OptionsMixin

   _getOptions() {
      // @ts-ignore
      let options = OptionsMixin.prototype._getOptions.call(this);

      //Delete "writable" property received from _options
      delete options.writable;
      return options;
   }

   //endregion WS.Data/Entity/OptionsMixin
};

// @ts-ignore
const IS_BROWSER = typeof window !== 'undefined';
// @ts-ignore
const IS_TESTING = !!(typeof global !== 'undefined' && global.assert && global.assert.strictEqual);

/**
 * @property {Boolean} Объект можно модифицировать. Запрет модификации выключит механизмы генерации событий (ObservableMixin).
 */
Object.defineProperty(ReadWriteMixin, $writable, {
   writable: true,
   value: IS_BROWSER || IS_TESTING
});

export default ReadWriteMixin;

/// <amd-module name="Data/_source/provider/SbisBusinessLogic" />
/**
 * JSON-RPC Провайдер для бизнес-логики СБиС
 * @class WS.Data/Source/Provider/SbisBusinessLogic
 * @implements WS.Data/Source/Provider/IAbstract
 * @mixes WS.Data/Entity/OptionsMixin
 * @public
 * @author Мальцев А.А.
 */

import IAbstract from './IAbstract';
import {OptionsMixin} from '../../type';
import {di, mixin} from '../../util';
// @ts-ignore
import RpcJson = require('Transport/RPCJSON');

export default class SbisBusinessLogic extends mixin(Object, OptionsMixin) implements IAbstract /** @lends WS.Data/Entity/SbisBusinessLogic.prototype */{
   readonly '[Data/_source/provider/IAbstract]': boolean = true;

   /**
    * @cfg {Endpoint} Конечная точка, обеспечивающая доступ клиента к БЛ
    * @name WS.Data/Source/Provider/SbisBusinessLogic#endpoint
    * @see getEndPoint
    * @example
    * <pre>
    *    var dataSource = new SbisBusinessLogic({
    *       endpoint: {
    *          address: '/service/url/',
    *          contract: 'Сотрудник'
    *       }
    *    });
    * </pre>
    */
   _$endpoint: any = {};

   /**
    * @cfg {Function} Конструктор сетевого транспорта
    */
   _$transport: any;

   /**
    * Разделитель пространств имен
    */
   _nameSpaceSeparator: string;

   constructor(options?) {
      super();
      OptionsMixin.call(this, options);
   }

   /**
    * Возвращает конечную точку, обеспечивающую доступ клиента к функциональным возможностям БЛ
    * @return {Endpoint}
    * @see endpoint
    */
   getEndpoint() {
      return this._$endpoint;
   }

   call(name: string, args: Array<string> | Object): ExtendPromise<any> {
      name = name + '';
      args = args || {};

      const Transport = this._$transport;
      let endpoint = this.getEndpoint();
      let overrideContract = name.indexOf('.') > -1;

      if (!overrideContract && endpoint.contract) {
         name = endpoint.contract + this._nameSpaceSeparator + name;
      }

      return new Transport({
         serviceUrl: endpoint.address
      }).callMethod(name, args);
   }
}

SbisBusinessLogic.prototype['[Data/_source/provider/SbisBusinessLogic]'] = true;
SbisBusinessLogic.prototype._$transport = RpcJson;
SbisBusinessLogic.prototype._nameSpaceSeparator = '.';

di.register('Data/source:provider.SbisBusinessLogic', SbisBusinessLogic, {instantiate: false});
